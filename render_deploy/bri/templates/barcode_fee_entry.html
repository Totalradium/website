<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barcode Fee Entry</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .form-section {
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar {
      border-right: 1px solid #ddd;
      height: 100vh;
      padding-top: 30px;
    }

    .sidebar h5 {
      margin-bottom: 20px;
    }

    .sidebar a {
      display: block;
      padding: 10px 15px;
      color: #333;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 5px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #2bb3b3;
      color: #fff;
    }

    .form-title {
      font-weight: bold;
      margin-bottom: 25px;
      color: #2bb3b3;
    }

    .btn-custom {
      background-color: #2bb3b3;
      color: #fff;
      border: none;
    }

    .btn-custom:hover {
      background-color: #239292;
    }

    #barcodeInput {
      font-size: 24px;
      padding: 15px;
      text-align: center;
      border: 3px solid #2bb3b3;
    }

    .recent-entry {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar no-print">
        <div class="text-center mb-4">
          {% load static %}
          {% if request.session.user_picture %}
            <img src="{{ request.session.user_picture }}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% else %}
            <img src="{% static 'user_img.png' %}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% endif %}
          <h5>{{ request.session.user_name|default:'Admin' }}</h5>
        </div>
        <a href="{% url 'studentss' %}">Students</a>
        <a href="{% url 'add_teacher' %}">Teachers</a>
        <a href="{% url 'fee_dashboard' %}" class="active">Fee Section</a>
        <a href="{% url 'attendance_home' %}">Attendance</a>
        <a href="{% url 'test_management' %}">Test Management</a>
        <a href="{% url 'add_user' %}">Users</a>
        <a href="#">WhatsApp</a>
        <a href="#">Reports</a>
        <a href="{% url 'batch_management' %}">Batch Management</a>
        <a href="{% url 'subject_management' %}" style="margin-left: 20px; font-size: 14px;">Subject Management</a>
        <hr>
        <a href="{% url 'logout_view' %}" class="text-danger">Logout</a>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-10 p-5">
        <div class="form-section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="form-title">Barcode Fee Entry System</h3>
            <div>
              <a href="{% url 'fee_dashboard' %}" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
            </div>
          </div>

          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-body text-center">
                  <h4>Scan Student Barcode</h4>
                  <p class="text-muted">Focus on the input below and scan the student's barcode</p>
                  
                  <input type="text" id="barcodeInput" class="form-control mb-3" placeholder="Scan barcode here..." autofocus>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="month" class="form-label">Month</label>
                      <input type="month" id="month" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="paymentMethod" class="form-label">Payment Method</label>
                      <select id="paymentMethod" class="form-control">
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Online">Online Payment</option>
                        <option value="Cheque">Cheque</option>
                      </select>
                    </div>
                  </div>

                  <div id="studentInfo" class="alert alert-info" style="display: none;">
                    <h5 id="studentName"></h5>
                    <p id="studentDetails"></p>
                    <p id="feeAmount"></p>
                    <p id="feeStatus"></p>
                    <div id="pendingFees"></div>
                  </div>

                  <div id="messages"></div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h5>Recent Entries</h5>
                </div>
                <div class="card-body" id="recentEntries" style="max-height: 400px; overflow-y: auto;">
                  <!-- Recent entries will be added here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const barcodeInput = document.getElementById('barcodeInput');
    const monthInput = document.getElementById('month');
    const paymentMethodInput = document.getElementById('paymentMethod');
    const studentInfo = document.getElementById('studentInfo');
    const messages = document.getElementById('messages');
    const recentEntries = document.getElementById('recentEntries');

    // Set current month as default
    const now = new Date();
    monthInput.value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

    barcodeInput.addEventListener('input', function() {
      const barcode = this.value.trim();
      
      if (barcode.length >= 3) { // Minimum barcode length
        processBarcode(barcode);
      }
    });

    function processBarcode(barcode) {
      const month = monthInput.value;
      const paymentMethod = paymentMethodInput.value;

      if (!month) {
        showMessage('Please select a month first!', 'warning');
        return;
      }

      // Send AJAX request to process barcode
      fetch('/barcode_fee_entry/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          barcode: barcode,
          month: month,
          payment_method: paymentMethod
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showStudentInfo(data.student, data.amount);
          showMessage(`Fee paid successfully for ${data.student.name}!`, 'success');
          addRecentEntry(data.student, data.amount, paymentMethod);
        } else {
          showMessage(data.error, 'danger');
        }
        
        // Clear input for next scan
        barcodeInput.value = '';
        barcodeInput.focus();
      })
      .catch(error => {
        showMessage('Error processing barcode. Please try again.', 'danger');
        barcodeInput.value = '';
        barcodeInput.focus();
      });
    }

    function showStudentInfo(student, amount) {
      document.getElementById('studentName').textContent = student.name;
      document.getElementById('studentDetails').textContent = `Class: ${student.class} - Section: ${student.section} | Roll: ${student.roll}`;
      document.getElementById('feeAmount').textContent = `Amount: PKR ${amount}`;
      document.getElementById('feeStatus').textContent = `Guardian: ${student.guardian || 'N/A'}`;
      
      // Show pending fees if available
      if (student.pending_fees && student.pending_fees.length > 0) {
        let pendingHtml = '<strong>Pending Fees:</strong><br>';
        student.pending_fees.forEach(fee => {
          pendingHtml += `<small>â€¢ ${fee.description} (${fee.month}): PKR ${fee.amount}</small><br>`;
        });
        document.getElementById('pendingFees').innerHTML = pendingHtml;
      } else {
        document.getElementById('pendingFees').innerHTML = '<small class="text-success">No pending fees</small>';
      }
      
      studentInfo.style.display = 'block';
      
      setTimeout(() => {
        studentInfo.style.display = 'none';
      }, 5000);
    }

    function showMessage(message, type) {
      messages.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
      
      setTimeout(() => {
        messages.innerHTML = '';
      }, 3000);
    }

    function addRecentEntry(student, amount, paymentMethod) {
      const entry = document.createElement('div');
      entry.className = 'recent-entry';
      entry.innerHTML = `
        <strong>${student.name}</strong><br>
        <small>${student.class}-${student.section} | PKR ${amount} | ${paymentMethod}</small><br>
        <small class="text-muted">${new Date().toLocaleTimeString()}</small>
      `;
      
      recentEntries.insertBefore(entry, recentEntries.firstChild);
      
      // Keep only last 10 entries
      while (recentEntries.children.length > 10) {
        recentEntries.removeChild(recentEntries.lastChild);
      }
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Keep focus on barcode input
    setInterval(() => {
      if (document.activeElement !== barcodeInput) {
        barcodeInput.focus();
      }
    }, 1000);
  </script>
</body>
</html>