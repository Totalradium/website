<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sync to Online - Brightway</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .form-section {
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .sidebar {
      border-right: 1px solid #ddd;
      height: 100vh;
      padding-top: 30px;
    }
    .sidebar h5 {
      margin-bottom: 20px;
    }
    .sidebar a {
      display: block;
      padding: 10px 15px;
      color: #333;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 5px;
    }
    .sidebar a:hover,
    .sidebar a.active {
      background-color: #2bb3b3;
      color: #fff;
    }
    .form-title {
      font-weight: bold;
      margin-bottom: 25px;
      color: #2bb3b3;
    }
    .btn-custom {
      background-color: #2bb3b3;
      color: #fff;
      border: none;
    }
    .btn-custom:hover {
      background-color: #239292;
    }
    .sync-card { transition: transform 0.2s; }
    .sync-card:hover { transform: translateY(-2px); }
    .status-success { color: #28a745; }
    .status-error { color: #dc3545; }
    .status-pending { color: #ffc107; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <div class="text-center mb-4">
          {% load static %}
          {% if request.session.user_picture %}
            <img src="{{ request.session.user_picture }}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% else %}
            <img src="{% static 'user_img.png' %}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% endif %}
          <h5>{{ request.session.user_name|default:'Admin' }}</h5>
        </div>
        <a href="{% url 'studentss' %}">Students</a>
        <a href="{% url 'add_teacher' %}">Teachers</a>
        <a href="{% url 'fee_dashboard' %}">Fee Section</a>
        <a href="{% url 'attendance_home' %}">Attendance</a>
        <a href="{% url 'test_management' %}">Test Management</a>
        <a href="{% url 'add_user' %}">Users</a>
        <a href="{% url 'whatsapp_integration' %}">WhatsApp</a>
        <a href="{% url 'sync_dashboard' %}" class="active">Sync to Online</a>
        <a href="{% url 'reports_dashboard' %}">Reports</a>
        <a href="{% url 'batch_management' %}">Batch Management</a>
        <a href="{% url 'subject_management' %}" style="margin-left: 20px; font-size: 14px;">Subject Management</a>
        <hr>
        <a href="{% url 'logout_view' %}" class="text-danger">Logout</a>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-10 p-5">
        <div class="form-section">
          <h3 class="form-title"><i class="fas fa-sync-alt"></i> Data Synchronization Dashboard</h3>
          <p class="text-muted mb-4">Sync your local data to the online server</p>
          
          <!-- Sync Status -->
          <div class="alert alert-info">
            <h6><i class="fas fa-info-circle"></i> Sync Status</h6>
            <div id="sync-status">Ready to sync</div>
            <div id="last-sync">Last sync: Never</div>
            <small class="text-muted">Large datasets are processed in batches to prevent timeouts</small>
          </div>

          <!-- Sync Options -->
          <div class="row mb-4">
            <div class="col-md-4 mb-3">
              <div class="card sync-card h-100">
                <div class="card-body text-center">
                  <i class="fas fa-users fa-3x text-primary mb-3"></i>
                  <h5>Students Data</h5>
                  <p class="text-muted">Sync student records, classes, and sections</p>
                  <button class="btn btn-primary" onclick="syncData('students')">
                    <i class="fas fa-upload"></i> Sync Students
                  </button>
                </div>
              </div>
            </div>
            
            <div class="col-md-4 mb-3">
              <div class="card sync-card h-100">
                <div class="card-body text-center">
                  <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
                  <h5>Attendance</h5>
                  <p class="text-muted">Sync attendance records (last 30 days)</p>
                  <button class="btn btn-success" onclick="syncData('attendance')">
                    <i class="fas fa-upload"></i> Sync Attendance
                  </button>
                </div>
              </div>
            </div>
            
            <div class="col-md-4 mb-3">
              <div class="card sync-card h-100">
                <div class="card-body text-center">
                  <i class="fas fa-money-bill-wave fa-3x text-warning mb-3"></i>
                  <h5>Fee Records</h5>
                  <p class="text-muted">Sync fee structure and payment records</p>
                  <button class="btn btn-warning" onclick="syncData('fees')">
                    <i class="fas fa-upload"></i> Sync Fees
                  </button>
                </div>
              </div>
            </div>
            
            <div class="col-md-4 mb-3">
              <div class="card sync-card h-100">
                <div class="card-body text-center">
                  <i class="fas fa-chalkboard-teacher fa-3x text-info mb-3"></i>
                  <h5>Teachers</h5>
                  <p class="text-muted">Sync teacher records and information</p>
                  <button class="btn btn-info" onclick="syncData('teachers')">
                    <i class="fas fa-upload"></i> Sync Teachers
                  </button>
                </div>
              </div>
            </div>
            
            <div class="col-md-4 mb-3">
              <div class="card sync-card h-100">
                <div class="card-body text-center">
                  <i class="fas fa-clipboard-list fa-3x text-secondary mb-3"></i>
                  <h5>Exams & Tests</h5>
                  <p class="text-muted">Sync test sessions, subjects, and exam data</p>
                  <button class="btn btn-secondary" onclick="syncData('exams')">
                    <i class="fas fa-upload"></i> Sync Exams
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Sync All Button -->
          <div class="text-center mb-4">
            <button class="btn btn-lg btn-danger" onclick="syncData('all')">
              <i class="fas fa-sync-alt"></i> Sync All Data
            </button>
          </div>

          <!-- Progress Bar -->
          <div id="progress-container" style="display: none;">
            <div class="progress mb-3">
              <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="text-center">Preparing sync...</div>
          </div>

          <!-- Results -->
          <div id="sync-results" style="display: none;">
            <h6>Sync Results:</h6>
            <div id="results-content"></div>
          </div>

          <!-- Configuration -->
          <div class="card mt-4">
            <div class="card-header">
              <h6><i class="fas fa-cog"></i> Configuration</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <label>Remote Server URL:</label>
                  <input type="text" id="remote-url" class="form-control" 
                         placeholder="https://your-app.onrender.com" 
                         value="https://your-render-app.onrender.com">
                </div>
                <div class="col-md-6">
                  <label>API Key:</label>
                  <input type="password" id="api-key" class="form-control" 
                         placeholder="Enter your API key"
                         value="your-secret-api-key">
                </div>
              </div>
              <div class="mt-3">
                <button class="btn btn-outline-primary btn-sm" onclick="testConnection()">
                  <i class="fas fa-plug"></i> Test Connection
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function syncData(syncType) {
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const resultsDiv = document.getElementById('sync-results');
      const statusDiv = document.getElementById('sync-status');
      
      // Show progress
      progressContainer.style.display = 'block';
      resultsDiv.style.display = 'none';
      progressBar.style.width = '10%';
      progressText.textContent = 'Starting sync...';
      statusDiv.innerHTML = '<span class="status-pending">Syncing...</span>';
      
      // Disable all buttons
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);
      
      // Simulate progress
      let progress = 10;
      const progressInterval = setInterval(() => {
        progress += 5;
        progressBar.style.width = progress + '%';
        if (progress >= 85) {
          clearInterval(progressInterval);
        }
      }, 500);
      
      // Make API call
      fetch('/sync/to-remote/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          sync_type: syncType,
          remote_url: document.getElementById('remote-url').value,
          api_key: document.getElementById('api-key').value
        })
      })
      .then(response => response.json())
      .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = 'Sync completed!';
        
        // Show results
        setTimeout(() => {
          progressContainer.style.display = 'none';
          resultsDiv.style.display = 'block';
          
          if (data.success) {
            statusDiv.innerHTML = '<span class="status-success">Sync completed successfully</span>';
            document.getElementById('last-sync').textContent = 'Last sync: ' + new Date().toLocaleString();
            
            let resultsHtml = '<div class="alert alert-success">Sync completed successfully!</div>';
            if (data.results) {
              resultsHtml += '<ul class="list-group">';
              for (const [key, value] of Object.entries(data.results)) {
                resultsHtml += `<li class="list-group-item d-flex justify-content-between">
                  <span>${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                  <span class="badge bg-success">${value.status} (${value.count || 0} records)</span>
                </li>`;
              }
              resultsHtml += '</ul>';
            }
            document.getElementById('results-content').innerHTML = resultsHtml;
          } else {
            statusDiv.innerHTML = '<span class="status-error">Sync failed</span>';
            document.getElementById('results-content').innerHTML = 
              `<div class="alert alert-danger">Error: ${data.error}</div>`;
          }
        }, 1000);
      })
      .catch(error => {
        clearInterval(progressInterval);
        progressContainer.style.display = 'none';
        statusDiv.innerHTML = '<span class="status-error">Sync failed</span>';
        document.getElementById('results-content').innerHTML = 
          `<div class="alert alert-danger">Network error: ${error.message}</div>`;
        resultsDiv.style.display = 'block';
      })
      .finally(() => {
        // Re-enable buttons
        buttons.forEach(btn => btn.disabled = false);
      });
    }
    
    function testConnection() {
      const url = document.getElementById('remote-url').value;
      const apiKey = document.getElementById('api-key').value;
      
      if (!url || !apiKey) {
        alert('Please enter both URL and API key');
        return;
      }
      
      // Simple connection test
      fetch(url + '/api/health/', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + apiKey
        }
      })
      .then(response => {
        if (response.ok) {
          alert('Connection successful!');
        } else {
          alert('Connection failed: ' + response.status);
        }
      })
      .catch(error => {
        alert('Connection error: ' + error.message);
      });
    }
    
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>