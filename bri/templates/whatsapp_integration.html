<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp Integration</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .form-section {
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar {
      border-right: 1px solid #ddd;
      height: 100vh;
      padding-top: 30px;
    }

    .sidebar h5 {
      margin-bottom: 20px;
    }

    .sidebar a {
      display: block;
      padding: 10px 15px;
      color: #333;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 5px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #2bb3b3;
      color: #fff;
    }

    .form-title {
      font-weight: bold;
      margin-bottom: 25px;
      color: #2bb3b3;
    }

    .btn-custom {
      background-color: #2bb3b3;
      color: #fff;
      border: none;
    }

    .btn-custom:hover {
      background-color: #239292;
    }

    .whatsapp-status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-connected {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-disconnected {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .qr-container {
      text-align: center;
      padding: 20px;
      border: 2px dashed #ddd;
      border-radius: 10px;
      margin: 20px 0;
    }

    .message-template {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #2bb3b3;
      margin: 10px 0;
    }

    .student-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <div class="text-center mb-4">
          {% load static %}
          {% if request.session.user_picture %}
            <img src="{{ request.session.user_picture }}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% else %}
            <img src="{% static 'user_img.png' %}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% endif %}
          <h5>{{ request.session.user_name|default:'Admin' }}</h5>
        </div>
        <a href="{% url 'studentss' %}">Students</a>
        <a href="{% url 'add_teacher' %}">Teachers</a>
        <a href="{% url 'fee_dashboard' %}">Fee Section</a>
        <a href="{% url 'attendance_dashboard' %}">Attendance</a>
        <a href="{% url 'test_management' %}">Test Management</a>
        <a href="{% url 'add_user' %}">Users</a>
        <a href="{% url 'whatsapp_integration' %}" class="active">WhatsApp</a>
        <a href="{% url 'reports_dashboard' %}">Reports</a>
        <a href="{% url 'batch_management' %}">Batch Management</a>
        <a href="{% url 'subject_management' %}" style="margin-left: 20px; font-size: 14px;">Subject Management</a>
        <hr>
        <a href="{% url 'logout_view' %}" class="text-danger">Logout</a>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-10 p-5">
        <div class="form-section">
          <h3 class="form-title">
            <i class="fab fa-whatsapp"></i> WhatsApp Integration
          </h3>

          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}

          <!-- Manual WhatsApp Notice -->
          <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Quick WhatsApp Integration</h5>
            <p>This opens WhatsApp Web tabs with pre-filled messages. Just press <kbd>Enter</kbd> in each tab to send. Much faster than typing manually!</p>
          </div>



          <!-- Message Sending Section -->
          <div id="message-section">
            <div class="row">
              <div class="col-md-6">
                <h5>Send Attendance Messages</h5>
                
                <!-- Filter Students -->
                <form id="filter-form" class="mb-4">
                  {% csrf_token %}
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="class_id" class="form-label">Class</label>
                      <select name="class_id" id="class_id" class="form-control">
                        <option value="">-- All Classes --</option>
                        {% for class in classes %}
                          <option value="{{ class.id }}">{{ class.class_name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="section_id" class="form-label">Section</label>
                      <select name="section_id" id="section_id" class="form-control" disabled>
                        <option value="">-- All Sections --</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="attendance_date" class="form-label">Attendance Date</label>
                      <input type="date" name="attendance_date" id="attendance_date" class="form-control" value="{{ today_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-6">
                      <label for="message_type" class="form-label">Message Type</label>
                      <select name="message_type" id="message_type" class="form-control" onchange="toggleMessageOptions()">
                        <option value="absent">Absent Students</option>
                        <option value="present">Present Students</option>
                        <option value="all">All Students</option>
                        <option value="fee_reminder">Fee Reminders</option>
                      </select>
                    </div>
                    
                    <!-- Fee Reminder Options -->
                    <div id="feeReminderOptions" class="col-md-12" style="display: none;">
                      <div class="row">
                        <div class="col-md-6">
                          <label for="fee_month" class="form-label">Fee Month</label>
                          <input type="month" id="fee_month" class="form-control">
                        </div>
                        <div class="col-md-6">
                          <label for="fee_status" class="form-label">Fee Status</label>
                          <select id="fee_status" class="form-control">
                            <option value="unpaid">Unpaid Only</option>
                            <option value="all">All Students</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <button type="button" id="load-students" class="btn btn-primary">Load Students</button>
                    </div>
                  </div>
                </form>

                <!-- Message Template -->
                <div class="mb-4">
                  <label for="message_template" class="form-label">Message Template</label>
                  <textarea id="message_template" class="form-control" rows="4" placeholder="Enter your message template...">Dear Parent,

Your child {student_name} from {class_name}-{section_name} was {status} today ({date}).

Thank you,
Brightway Foundation School And Academy</textarea>
                  <small class="text-muted" id="available-variables">
                    Available variables: {student_name}, {class_name}, {section_name}, {status}, {date}, {time}
                  </small>
                </div>

                <!-- Browser Selection -->
                <div class="mb-4">
                  <label for="browser_select" class="form-label">Browser for Automation</label>
                  <select id="browser_select" class="form-control">
                    <option value="chrome">Google Chrome</option>
                  </select>
                  <small class="text-muted">Choose which browser to use for automation</small>
                </div>

                <div class="d-flex gap-2">
                  <button id="automate-messages" class="btn btn-primary" disabled>
                    <i class="fas fa-robot"></i> Send Messages
                  </button>
                  <button id="auto-notify" class="btn btn-warning" title="Quick setup for today's absent students">
                    <i class="fas fa-magic"></i> Quick Notify Absent
                  </button>
                  <a href="{% url 'attendance_notifications' %}" class="btn btn-info">
                    <i class="fas fa-cog"></i>                Sent Notifications </a>
                </div>
                <small class="text-muted mt-2 d-block">
                  <i class="fas fa-info-circle"></i> <strong>Automation:</strong> Opens browser, scan QR code if needed, then sends messages automatically.
                </small>
              </div>

              <div class="col-md-6">
                <h5>Selected Students</h5>
                <div id="student-list" class="student-list">
                  <p class="text-muted">Load students to see the list</p>
                </div>
                
                <div class="mt-3">
                  <strong>Total Students: <span id="student-count">0</span></strong>
                </div>

                <!-- Test Message Section -->
                <div class="mt-4 p-3 border rounded bg-light">
                  <h6><i class="fas fa-flask"></i> Test Message</h6>
                  <div class="mb-2">
                    <label for="test_phone" class="form-label">Phone Number</label>
                    <input type="text" id="test_phone" class="form-control" placeholder="+923001234567">
                  </div>
                  <div class="mb-2">
                    <label for="test_message" class="form-label">Message</label>
                    <textarea id="test_message" class="form-control" rows="2" placeholder="Test message">Hello! This is an automated test message from BRIGHTWAY FOUNDATION SCHOOL AND ACADEMY.</textarea>
                  </div>
                  <button id="send-test" class="btn btn-sm btn-info">
                    <i class="fas fa-paper-plane"></i> Send Test
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Message Status & Log -->
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6><i class="fas fa-clock"></i> Pending Messages</h6>
                  <span id="pending-count" class="badge bg-warning">0</span>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                  <div id="pending-messages">
                    <p class="text-muted">No pending messages</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6><i class="fas fa-check"></i> Sent Messages</h6>
                  <span id="sent-count" class="badge bg-success">0</span>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                  <div id="sent-messages">
                    <p class="text-muted">No messages sent yet</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Message Log -->
          <div id="message-log" class="mt-4" style="display: none;">
            <h5>Message Log</h5>
            <div id="log-content" class="border rounded p-3" style="height: 200px; overflow-y: auto; background: #f8f9fa;">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let selectedStudents = [];
    let pendingMessages = [];
    let sentMessages = [];

    // Don't auto-dismiss alerts - let user read them

    // Class-Section cascade
    document.getElementById('class_id').addEventListener('change', function() {
      const classId = this.value;
      const sectionSelect = document.getElementById('section_id');
      
      sectionSelect.innerHTML = '<option value="">-- All Sections --</option>';
      sectionSelect.disabled = !classId;
      
      if (classId) {
        fetch(`/get_sections_for_class/${classId}/`)
          .then(response => response.json())
          .then(data => {
            data.sections.forEach(section => {
              const option = document.createElement('option');
              option.value = section.id;
              option.text = section.std_section;
              sectionSelect.appendChild(option);
            });
          });
      }
    });

    // Toggle message options based on type
    function toggleMessageOptions() {
      const messageType = document.getElementById('message_type').value;
      const feeOptions = document.getElementById('feeReminderOptions');
      const messageTemplate = document.getElementById('message_template');
      
      if (messageType === 'fee_reminder') {
        feeOptions.style.display = 'block';
        // Set current month as default
        const now = new Date();
        document.getElementById('fee_month').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        
        // Change message template for fee reminders
        messageTemplate.value = `Dear Parent,

This is a friendly reminder that the fee for {student_name} from {class_name}-{section_name} for the month of {fee_month} is still pending.

Amount Due: PKR {fee_amount}
Due Date: {due_date}

Please make the payment at your earliest convenience to avoid any inconvenience.

Thank you,
Brightway Foundation School And Academy`;
        
        // Update available variables for fee reminders
        document.getElementById('available-variables').innerHTML = 'Available variables: {student_name}, {class_name}, {section_name}, {fee_amount}, {fee_month}, {due_date}';
      } else {
        feeOptions.style.display = 'none';
        
        // Reset to attendance template
        messageTemplate.value = `Dear Parent,

Your child {student_name} from {class_name}-{section_name} was {status} today ({date}).

Thank you,
Brightway Foundation School And Academy`;
        
        // Update available variables for attendance
        document.getElementById('available-variables').innerHTML = 'Available variables: {student_name}, {class_name}, {section_name}, {status}, {date}, {time}';
      }
    }

    // Load students
    document.getElementById('load-students').addEventListener('click', function() {
      const messageType = document.getElementById('message_type').value;
      
      if (messageType === 'fee_reminder') {
        loadFeeStudents();
      } else {
        loadAttendanceStudents();
      }
    });
    
    function loadAttendanceStudents() {
      const classId = document.getElementById('class_id').value;
      const sectionId = document.getElementById('section_id').value;
      const attendanceDate = document.getElementById('attendance_date').value;
      const messageType = document.getElementById('message_type').value;

      if (!attendanceDate) {
        alert('Please select attendance date');
        return;
      }

      const formData = new FormData();
      formData.append('class_id', classId);
      formData.append('section_id', sectionId);
      formData.append('attendance_date', attendanceDate);
      formData.append('message_type', messageType);
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
      
      fetch('/get_students_with_attendance/', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        selectedStudents = data.students || [];
        displayStudents(selectedStudents);
        document.getElementById('automate-messages').disabled = selectedStudents.length === 0;
        
        // Add to pending messages with actual message content
        const template = document.getElementById('message_template').value;
        const attendanceDate = document.getElementById('attendance_date').value;
        
        pendingMessages = selectedStudents.map(student => {
          let message = template
            .replace('{student_name}', student.name)
            .replace('{class_name}', student.class)
            .replace('{section_name}', student.section)
            .replace('{status}', student.status)
            .replace('{date}', attendanceDate)
            .replace('{time}', new Date().toLocaleTimeString());
            
          return {
            ...student,
            messageType: messageType,
            messageContent: message,
            timestamp: new Date().toLocaleString()
          };
        });
        updateMessageStatus();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading students: ' + error.message);
        selectedStudents = [];
        displayStudents(selectedStudents);
      });
    }
    
    function loadFeeStudents() {
      const classId = document.getElementById('class_id').value;
      const sectionId = document.getElementById('section_id').value;
      const feeMonth = document.getElementById('fee_month').value;
      const feeStatus = document.getElementById('fee_status').value;

      if (!feeMonth) {
        alert('Please select fee month');
        return;
      }

      const formData = new FormData();
      formData.append('class_id', classId);
      formData.append('section_id', sectionId);
      formData.append('fee_month', feeMonth);
      formData.append('fee_status', feeStatus);
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

      fetch('/get_students_with_fees/', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        selectedStudents = data.students || [];
        displayFeeStudents(selectedStudents);
        document.getElementById('automate-messages').disabled = selectedStudents.length === 0;
        
        // Add to pending messages with actual message content
        const template = document.getElementById('message_template').value;
        const feeMonth = document.getElementById('fee_month').value;
        
        pendingMessages = selectedStudents.map(student => {
          let message = template
            .replace('{student_name}', student.name)
            .replace('{class_name}', student.class)
            .replace('{section_name}', student.section)
            .replace('{fee_amount}', student.amount || 'N/A')
            .replace('{fee_month}', feeMonth)
            .replace('{due_date}', student.due_date || 'N/A');
            
          return {
            ...student,
            messageType: 'fee_reminder',
            messageContent: message,
            timestamp: new Date().toLocaleString()
          };
        });
        updateMessageStatus();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading fee students: ' + error.message);
        selectedStudents = [];
        displayStudents(selectedStudents);
      });
    }

    function displayStudents(students) {
      const listContainer = document.getElementById('student-list');
      const countElement = document.getElementById('student-count');
      
      if (students.length === 0) {
        listContainer.innerHTML = '<p class="text-muted">No students found</p>';
        countElement.textContent = '0';
        return;
      }

      let html = '';
      students.forEach(student => {
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <div>
              <strong>${student.name}</strong> (Roll: ${student.roll})<br>
              <small>${student.class}-${student.section} | 
                <span class="${student.phone === 'No Phone' || student.phone === 'Invalid Phone' ? 'text-danger' : 'text-success'}">
                  ${student.phone}
                </span>
              </small>
            </div>
            <span class="badge ${student.status === 'Present' ? 'bg-success' : 'bg-danger'}">
              ${student.status}
            </span>
          </div>
        `;
      });
      
      listContainer.innerHTML = html;
      countElement.textContent = students.length;
    }
    
    function displayFeeStudents(students) {
      const listContainer = document.getElementById('student-list');
      const countElement = document.getElementById('student-count');
      
      if (students.length === 0) {
        listContainer.innerHTML = '<p class="text-muted">No students found</p>';
        countElement.textContent = '0';
        return;
      }

      let html = '';
      students.forEach(student => {
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <div>
              <strong>${student.name}</strong> (Roll: ${student.roll})<br>
              <small>${student.class}-${student.section} | 
                <span class="${student.phone === 'No Phone' || student.phone === 'Invalid Phone' ? 'text-danger' : 'text-success'}">
                  ${student.phone}
                </span><br>
                Amount: PKR ${student.amount || 'N/A'}
              </small>
            </div>
            <span class="badge ${student.fee_status === 'Paid' ? 'bg-success' : 'bg-danger'}">
              ${student.fee_status || 'Unpaid'}
            </span>
          </div>
        `;
      });
      
      listContainer.innerHTML = html;
      countElement.textContent = students.length;
    }



    // Removed manual WhatsApp tabs functionality

    // Full automation using Node.js
    document.getElementById('automate-messages').addEventListener('click', function() {

      if (selectedStudents.length === 0) {
        alert('No students selected');
        return;
      }

      const template = document.getElementById('message_template').value;
      const logContainer = document.getElementById('log-content');
      document.getElementById('message-log').style.display = 'block';
      
      // Replace template variables for first student to create message template
      let message = template
        .replace('{student_name}', '{STUDENT_NAME}')
        .replace('{class_name}', selectedStudents[0].class)
        .replace('{section_name}', selectedStudents[0].section)
        .replace('{status}', '{STATUS}')
        .replace('{date}', document.getElementById('attendance_date').value)
        .replace('{time}', new Date().toLocaleTimeString());
      
      logContainer.innerHTML = '<p>Starting full automation with Selenium...</p>';
      
      // Send data to Django backend for Node.js automation
      fetch('/automate_whatsapp/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          students: selectedStudents,
          message: message,
          browser: document.getElementById('browser_select').value
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          logContainer.innerHTML += '<p><i class="fas fa-check text-success"></i> Selenium automation started successfully!</p>';
          logContainer.innerHTML += '<p><i class="fas fa-info-circle text-info"></i> Chrome browser will open. Please scan QR code if not logged in.</p>';
          logContainer.innerHTML += '<p><i class="fas fa-robot text-primary"></i> Messages will be sent automatically using Selenium...</p>';
          logContainer.innerHTML += '<p><i class="fas fa-clock text-warning"></i> Waiting for backend to send messages...</p>';
          
          // Poll for message status updates from backend
          const pollInterval = setInterval(() => {
            fetch('/get_message_status/', {
              method: 'GET',
              headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
            })
            .then(response => response.json())
            .then(statusData => {
              if (statusData.messages) {
                statusData.messages.forEach(msg => {
                  if (msg.status === 'sent') {
                    // Find and move message from pending to sent
                    const msgIndex = pendingMessages.findIndex(p => p.phone === msg.phone);
                    if (msgIndex !== -1) {
                      sentMessages.push(pendingMessages.splice(msgIndex, 1)[0]);
                      updateMessageStatus();
                      logContainer.innerHTML += `<p><i class="fas fa-check text-success"></i> Message sent to ${msg.phone}</p>`;
                      logContainer.scrollTop = logContainer.scrollHeight;
                    }
                  }
                });
              }
              
              if (statusData.completed) {
                clearInterval(pollInterval);
                logContainer.innerHTML += '<p><i class="fas fa-check text-success"></i> All messages sent successfully!</p>';
                logContainer.scrollTop = logContainer.scrollHeight;
              }
            })
            .catch(error => {
              console.error('Polling error:', error);
            });
          }, 2000); // Poll every 2 seconds
          
        } else {
          logContainer.innerHTML += `<p><i class="fas fa-exclamation-triangle text-danger"></i> Error: ${data.error}</p>`;
        }
        logContainer.scrollTop = logContainer.scrollHeight;
      })
      .catch(error => {
        logContainer.innerHTML += `<p><i class="fas fa-exclamation-triangle text-danger"></i> Network error: ${error.message}</p>`;
        logContainer.scrollTop = logContainer.scrollHeight;
      });
    });

    // Test message functionality
    document.getElementById('send-test').addEventListener('click', function() {
      const phone = document.getElementById('test_phone').value.trim();
      const message = document.getElementById('test_message').value.trim();
      
      if (!phone || !message) {
        alert('Please enter both phone number and message');
        return;
      }
      
      const logContainer = document.getElementById('log-content');
      document.getElementById('message-log').style.display = 'block';
      
      // Add test message to pending first
      const testMessage = {
        name: 'Test Contact',
        phone: phone,
        messageType: 'test',
        messageContent: message,
        timestamp: new Date().toLocaleString(),
        status: 'pending'
      };
      
      pendingMessages.push(testMessage);
      updateMessageStatus();
      
      logContainer.innerHTML = '<p>Sending test message...</p>';
      
      // Show as sending
      testMessage.status = 'sending';
      updateMessageStatus();
      
      fetch('/send_test_message/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          phone: phone,
          message: message
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          logContainer.innerHTML += '<p><i class="fas fa-info-circle text-info"></i> Test message queued for sending...</p>';
          
          // Start polling for test message status
          const pollTestMessage = setInterval(() => {
            fetch('/get_message_status/', {
              method: 'GET',
              headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
            })
            .then(response => response.json())
            .then(statusData => {
              if (statusData.messages) {
                const testMsg = statusData.messages.find(m => m.phone === phone && m.status === 'sent');
                if (testMsg) {
                  clearInterval(pollTestMessage);
                  // Move from pending to sent
                  const msgIndex = pendingMessages.findIndex(msg => msg.phone === phone && msg.messageType === 'test');
                  if (msgIndex !== -1) {
                    sentMessages.push(pendingMessages.splice(msgIndex, 1)[0]);
                  }
                  updateMessageStatus();
                  logContainer.innerHTML += '<p><i class="fas fa-check text-success"></i> Test message sent successfully!</p>';
                  logContainer.scrollTop = logContainer.scrollHeight;
                }
              }
            })
            .catch(error => {
              console.error('Test message polling error:', error);
            });
          }, 2000); // Poll every 2 seconds
          
          // Stop polling after 30 seconds if no confirmation
          setTimeout(() => {
            clearInterval(pollTestMessage);
          }, 30000);
          
        } else {
          // Keep in pending but mark as failed
          testMessage.status = 'failed';
          updateMessageStatus();
          logContainer.innerHTML += `<p><i class="fas fa-exclamation-triangle text-danger"></i> Error: ${data.error}</p>`;
        }
        logContainer.scrollTop = logContainer.scrollHeight;
      })
      .catch(error => {
        logContainer.innerHTML += `<p><i class="fas fa-exclamation-triangle text-danger"></i> Network error: ${error.message}</p>`;
        logContainer.scrollTop = logContainer.scrollHeight;
      });
    });

    // Add bulk send for attendance notifications
    function sendAttendanceNotifications() {
      const classId = document.getElementById('class_id').value;
      const sectionId = document.getElementById('section_id').value;
      const attendanceDate = document.getElementById('attendance_date').value;
      
      if (!classId || !attendanceDate) {
        alert('Please select class and attendance date');
        return;
      }
      
      // Auto-load absent students and send messages
      document.getElementById('message_type').value = 'absent';
      document.getElementById('load-students').click();
      
      setTimeout(() => {
        if (selectedStudents.length > 0) {
          document.getElementById('send-messages').click();
        }
      }, 1000);
    }
    
    // Auto notify absent students
    document.getElementById('auto-notify').addEventListener('click', function() {
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('attendance_date').value = today;
      document.getElementById('message_type').value = 'absent';
      
      // Load and send automatically
      document.getElementById('load-students').click();
      
      setTimeout(() => {
        if (selectedStudents.length > 0) {
          document.getElementById('send-messages').click();
        } else {
          alert('No absent students found for today!');
        }
      }, 1500);
    });
    
    // Update message status displays
    function updateMessageStatus() {
      const pendingContainer = document.getElementById('pending-messages');
      const sentContainer = document.getElementById('sent-messages');
      const pendingCount = document.getElementById('pending-count');
      const sentCount = document.getElementById('sent-count');
      
      // Update counts
      pendingCount.textContent = pendingMessages.length;
      sentCount.textContent = sentMessages.length;
      
      // Update pending messages
      if (pendingMessages.length === 0) {
        pendingContainer.innerHTML = '<p class="text-muted">No pending messages</p>';
      } else {
        let html = '';
        pendingMessages.forEach(msg => {
          let statusBadge;
          if (msg.status === 'sending') {
            statusBadge = '<span class="badge bg-info">Sending...</span>';
          } else if (msg.status === 'failed') {
            statusBadge = '<span class="badge bg-danger">Failed</span>';
          } else {
            statusBadge = '<span class="badge bg-warning">Pending</span>';
          }
            
          html += `
            <div class="mb-3 p-3 border rounded bg-light">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <strong>${msg.name}</strong><br>
                  <small class="text-muted">${msg.phone} | ${msg.messageType}</small>
                </div>
                ${statusBadge}
              </div>
              <div class="mt-2">
                <small class="text-muted">Message:</small>
                <div class="p-2 bg-white border rounded" style="font-size: 12px; max-height: 100px; overflow-y: auto;">
                  ${msg.messageContent.replace(/\n/g, '<br>')}
                </div>
              </div>
            </div>
          `;
        });
        pendingContainer.innerHTML = html;
      }
      
      // Update sent messages
      if (sentMessages.length === 0) {
        sentContainer.innerHTML = '<p class="text-muted">No messages sent yet</p>';
      } else {
        let html = '';
        sentMessages.forEach(msg => {
          html += `
            <div class="mb-3 p-3 border rounded bg-light">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <strong>${msg.name}</strong><br>
                  <small class="text-muted">${msg.phone} | ${msg.messageType}<br>
                  Sent: ${msg.timestamp}</small>
                </div>
                <span class="badge bg-success">Sent</span>
              </div>
              <div class="mt-2">
                <small class="text-muted">Message:</small>
                <div class="p-2 bg-white border rounded" style="font-size: 12px; max-height: 100px; overflow-y: auto;">
                  ${msg.messageContent.replace(/\n/g, '<br>')}
                </div>
              </div>
            </div>
          `;
        });
        sentContainer.innerHTML = html;
      }
    }
  </script>
</body>
</html>
