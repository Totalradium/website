<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Notifications</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .form-section {
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar {
      border-right: 1px solid #ddd;
      height: 100vh;
      padding-top: 30px;
    }

    .sidebar a {
      display: block;
      padding: 10px 15px;
      color: #333;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 5px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #2bb3b3;
      color: #fff;
    }

    .form-title {
      font-weight: bold;
      margin-bottom: 25px;
      color: #2bb3b3;
    }

    .notification-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }

    .notification-item.sent {
      background: #d4edda;
      border-color: #c3e6cb;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <div class="text-center mb-4">
          {% load static %}
          {% if request.session.user_picture %}
            <img src="{{ request.session.user_picture }}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% else %}
            <img src="{% static 'user_img.png' %}" height="100px" class="rounded-circle mb-2" alt="User" />
          {% endif %}
          <h5>{{ request.session.user_name|default:'Admin' }}</h5>
        </div>
        <a href="{% url 'studentss' %}">Students</a>
        <a href="{% url 'add_teacher' %}">Teachers</a>
        <a href="{% url 'fee_dashboard' %}">Fee Section</a>
        <a href="{% url 'attendance_dashboard' %}">Attendance</a>
        <a href="{% url 'test_management' %}">Test Management</a>
        <a href="{% url 'add_user' %}">Users</a>
        <a href="{% url 'whatsapp_integration' %}" class="active">WhatsApp</a>
        <a href="{% url 'reports_dashboard' %}">Reports</a>
        <a href="{% url 'batch_management' %}">Batch Management</a>
        <a href="{% url 'subject_management' %}" style="margin-left: 20px; font-size: 14px;">Subject Management</a>
        <hr>
        <a href="{% url 'logout_view' %}" class="text-danger">Logout</a>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-10 p-5">
        <div class="form-section">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="form-title">
              <i class="fas fa-bell"></i> Attendance Notifications
            </h3>
            <div>
              <span class="badge bg-warning me-2">{{ total_pending }} Pending</span>
              <button id="send-all-btn" class="btn btn-success" {% if total_pending == 0 %}disabled{% endif %}>
                <i class="fas fa-paper-plane"></i> Send All
              </button>
              <button id="refresh-btn" class="btn btn-outline-primary ms-2">
                <i class="fas fa-sync"></i> Refresh
              </button>
            </div>
          </div>

          {% if total_pending == 0 %}
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> All attendance notifications have been sent!
            </div>
          {% else %}
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> {{ total_pending }} students need attendance notifications sent to their guardians.
            </div>
          {% endif %}

          <!-- Notifications List -->
          <div id="notifications-list">
            {% for notification in pending_notifications %}
            <div class="notification-item" data-id="{{ notification.id }}">
              <div class="row align-items-center">
                <div class="col-md-3">
                  <strong>{{ notification.student_name }}</strong><br>
                  <small class="text-muted">{{ notification.class }}-{{ notification.section }}</small>
                </div>
                <div class="col-md-2">
                  <span class="badge {% if notification.status == 'Present' %}bg-success{% else %}bg-danger{% endif %}">
                    {{ notification.status }}
                  </span>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">
                    <i class="fas fa-phone"></i> {{ notification.phone|default:'No Phone' }}
                  </small>
                </div>
                <div class="col-md-2">
                  <small class="text-muted">{{ notification.date }}</small>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-sm btn-primary send-single-btn" data-id="{{ notification.id }}">
                    <i class="fas fa-paper-plane"></i> Send
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Status Messages -->
          <div id="status-messages" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Send single notification
    document.querySelectorAll('.send-single-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const notificationId = this.dataset.id;
        const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
        
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        
        fetch('/send_notification/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({notification_id: notificationId})
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            notificationItem.classList.add('sent');
            notificationItem.style.display = 'none';
            showMessage('success', 'Notification sent successfully!');
            updatePendingCount();
          } else {
            showMessage('danger', 'Failed to send: ' + data.error);
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
          }
        })
        .catch(error => {
          showMessage('danger', 'Error: ' + error.message);
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
        });
      });
    });

    // Send all notifications
    document.getElementById('send-all-btn').addEventListener('click', function() {
      if (!confirm('Send notifications to all pending students?')) return;
      
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending All...';
      
      fetch('/send_all_notifications/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showMessage('success', data.message);
          setTimeout(() => location.reload(), 3000);
        } else {
          showMessage('danger', 'Failed: ' + data.error);
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-paper-plane"></i> Send All';
        }
      });
    });

    // Refresh page
    document.getElementById('refresh-btn').addEventListener('click', function() {
      location.reload();
    });

    function showMessage(type, message) {
      const statusDiv = document.getElementById('status-messages');
      statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => statusDiv.innerHTML = '', 5000);
    }

    function updatePendingCount() {
      fetch('/get_pending_count/')
        .then(response => response.json())
        .then(data => {
          const badge = document.querySelector('.badge');
          badge.textContent = `${data.pending_count} Pending`;
          
          if (data.pending_count === 0) {
            document.getElementById('send-all-btn').disabled = true;
          }
        });
    }

    // Add CSRF token
    const csrfToken = '{{ csrf_token }}';
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    document.body.appendChild(csrfInput);
  </script>
</body>
</html>
